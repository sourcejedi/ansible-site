# Init jenkins-desktop.
#
# Debian does not implement "No open ports" (aspirational ubuntu policy).
# I suggest *always* initializing systems on a firewalled network.
# (E.g. standard home router config.  Sucks if you don't have a router.)
# Once this role is run, a firewall will be installed, and will allow the SSH port.
#
# Debian 9 install only.
# Not validated for upgrade from Debian < 9.


- hosts: drystone
  roles:
    - role: repos-apt
      repos_apt: debian-stretch

    - sourcejedi.etckeeper

    - users
    - sourcejedi.systemd-journal
    - systemd-coredump

    - role: firewalld
      firewalld__services:
       - dhcpv6-client
       - mdns
       - ssh

    - sourcejedi.atop

    # Cleanup. In particular, remove updatedb task.
    - remove-rpcbind
    - remove-mlocate-on-deb

    # Create backup tasks.
    # Make sure to mount /data/backup/ first, I guess :).
    - { role: daily-borgbackup,
              daily_borgbackup__cron_prefix: '50-' }

    # Old backup system.  Role not completed.
    # If a full initialization is needed,
    # this would require additional manual steps.
    - { role: daily-bup,
              daily_bup__cron_prefix: '70-' }

    # Note - remote administration is not permitted on jenkins-desktop.
    # SSH may be used for other backups though.
    - openssh-server

    - jpegcheck
    - jenkins-photos

    - packages-trash-cli
    - packages-gui

  tasks:
    - name: /00-README.txt
      copy:
        dest: /00-README.txt
        src: "{{ inventory_dir }}/files/jenkins-desktop/README-rootfs.txt"
      tags: jenkins-desktop

    - name: /home/00-README.txt
      copy:
        dest: /home/00-README.txt
        src: "{{ inventory_dir }}/files/jenkins-desktop/README-home.txt"
      tags: jenkins-desktop

    - name: /data/00-README.txt
      copy:
        dest: /data/00-README.txt
        src: "{{ inventory_dir }}/files/jenkins-desktop/README-data.txt"
      tags: jenkins-desktop
